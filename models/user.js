/**
 * The data-layer for a User
 * @module Users
 */

let mongoose = require('mongoose');
let bcrypt = require('bcrypt-nodejs');
let Schema = mongoose.Schema;

let userSchema = mongoose.Schema({
    local: {
        username: String,
        token: String,
        status: Number,
        password: String,
        attempts: Number
    },
    google: {
        id: String,
        username: String,
        token: String,
    },
    linkedin: {
        id: String,
        username: String,
        token: String
    },
    outlook: {
        id: String,
        username: String,
        token: String,
    },
    facebook: {
        id: String,
        username: String,
        token: String,
    },
    twitter: {
        id: String,
        username: String,
        token: String,
    },
    shortId: String,
    socketId: String,
    roles: [String],
    displayName: String,
    firstName: String,
    lastName: String,
    email: String,
    lastAccess: Date,
    favorites: [{ type: Schema.Types.ObjectId, ref: 'Publication' }],
    reservations: [{
        publication: { type: Schema.Types.ObjectId, ref: 'Publication' },
        pendingtoqualify: Boolean
    }],
    reviews: {
        score: Number
    },
    plan: {
        type: Number,
        testMonth: Boolean,
        publicationsAvailable: Number,
        expiration: Date
    },
    billing: {
        mercadopago: String
    }
});

/**
 * Id Hasg Generator
 *
 * @function generateHash
 * @memberof module:Users~User
 * @this module:Users~User
 * @param {String} password
 * @returns autogenerated hash to save as Id
 */
userSchema.methods.generateHash = function(password) {
    return bcrypt.hashSync(password, bcrypt.genSaltSync(8), null);
};

/**
 * Password validation
 *
 * @function validPassword
 * @memberof module:Users~User
 * @this module:Users~User
 * @param {string} password
 * @returns True or False
 */
userSchema.methods.validPassword = function(password) {
    return bcrypt.compareSync(password, this.local.password);
};


/**
 * A composition of user Authentication profile data and Auth token data.
 * @typedef {Object}            Authentication
 * @property {string}           id            - Authentication user id of the user
 * @property {string}           username      - Username of authentication user
 * @property {string}           token         - Authentication long lived token to access user information later
 * @property {string}           password      - Password for authentication
 * @property {number}           attempts      - Number of attempts to authenticate
 * @property {number}           status=0      - Status of user authentication (0 - Pending to Confirm | 1 - Enabled | 2 - Disabled)
 */
/**
 * Details of the client Plan
 * @typedef {Object} Plan
 * @property {number}           type                    - Type of Plan (Stone - Bronze - Silver - Gold - Crystal)
 * @property {string}           testMonth               - Indicate is the actual month is test
 * @property {number}           publicationsAvailable   - Count of publications available 
 * @property {date}             expiration              - Date of publication expiration
 */

// TODO: Completar la documentacion
/**
 * Mongoose model for user document.
 *
 * @class User
 * @property {string}               firstName       - The first name of the user
 * @property {string}               lastName        - The last name of the user
 * @property {Plan}                 plan            - plan of the user
 * @property {Authentication}       authentication  - Authentication information of the user
 * @property {string}               shortId         - shortId of the user
 * @property {string}               socketId        - id of the socket.io of the user
 * @property {ArrayArray.<Role>}    roles           - list of roles for the user
 */
module.exports = mongoose.model('User', userSchema);